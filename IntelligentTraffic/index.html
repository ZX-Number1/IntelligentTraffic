<!DOCTYPE html>
<html lang="zh-TW">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>æ™ºæ…§äº¤é€šè¼”åŠ©ç³»çµ±</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
        <style>
            h1 {
                font-size: 50px;
                font-family: DFKai-sb;
                color: rgb(0, 0, 0);
            }
            video {
                width: 100%;
                max-width: 640px;
                border: 2px solid black;
            }
            button {
                font-size: 20px;
                padding: 10px;
                margin: 10px;
                cursor: pointer;
            }
            #status {
                text-align: center;
                margin-top: 20px;
                font-size: 18px;
                color: red;
            }
        </style>
    </head>
    <body>
        <center>
            <h1>æ™ºæ…§äº¤é€šè¼”åŠ©ç³»çµ±</h1>
            <marquee width="100%" direction="left" scrollamount="5">
                <font size="5" style="-webkit-text-stroke: 0.2px rgb(255, 255, 255);color:rgb(19, 55, 102);">
                    æ­¡è¿ä½¿ç”¨~&nbsp;&emsp;æ­¡è¿ä½¿ç”¨~
                </font>
            </marquee>
            
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" style="display: none;"></canvas>
            <br>
            <button id="startButton">é–‹å§‹æ”å½±æ©Ÿ</button>
            <button id="stopButton" disabled>åœæ­¢æ”å½±æ©Ÿ</button>
            <br><br>
            <img id="processedFrame" alt="è™•ç†å¾Œçš„å½±åƒ">
            <p id="detections"></p>
            <p id="status">ç­‰å¾…é–‹å§‹æ”å½±æ©Ÿ...</p>
        </center>
        <script>
            const video = document.getElementById("video");
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            const processedFrame = document.getElementById("processedFrame");
            const detectionsText = document.getElementById("detections");
            const statusText = document.getElementById("status");
    
            const startButton = document.getElementById("startButton");
            const stopButton = document.getElementById("stopButton");
    
            const socket = io("http://localhost:5000", { transports: ["websocket"] });
            socket.on("response_frame", function (data) {
                console.log("ğŸ“¸ æ”¶åˆ°å¾Œç«¯å›å‚³çš„å½±åƒ", data);
                
                if (data.image) {
                    processedFrame.src = "data:image/jpeg;base64," + data.image;
                    detectionsText.innerText = "åµæ¸¬çµæœï¼š" + JSON.stringify(data.detections, null, 2);
                } else {
                    console.error("âŒ æ²’æœ‰æ”¶åˆ°å½±åƒæ•¸æ“š");
                }
            });
            let stream = null;
            let captureInterval = null;
    
            // å•Ÿå‹•æ”å½±æ©Ÿ
            async function startCamera() {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    video.srcObject = stream;
                    statusText.innerText = "ğŸ¥ æ”å½±æ©Ÿå·²å•Ÿå‹•";
                    startButton.disabled = true;
                    stopButton.disabled = false;
    
                    socket.on("response_frame", function (data) {
                        console.log("ğŸ“¸ æ”¶åˆ°å¾Œç«¯å›å‚³çš„å½±åƒ");
                        
                        if (data.image) {
                            processedFrame.src = "data:image/jpeg;base64," + data.image;
                            detectionsText.innerText = "åµæ¸¬çµæœï¼š" + JSON.stringify(data.detections);
                        } else {
                            console.error("âŒ æ²’æœ‰æ”¶åˆ°å½±åƒæ•¸æ“š");
                        }
                    });
    
                    // æ¯ 400ms å‚³é€å½±åƒ
                    captureInterval = setInterval(() => {
                        captureAndSendFrame();
                    }, 400);
                } catch (err) {
                    console.error("âŒ ç„¡æ³•é–‹å•Ÿæ”å½±æ©Ÿ", err);
                    statusText.innerText = "ğŸš¨ é–‹å•Ÿæ”å½±æ©Ÿå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™";
                }
            }
    
            // åœæ­¢æ”å½±æ©Ÿ
            function stopCamera() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    video.srcObject = null;
                    clearInterval(captureInterval);
                    statusText.innerText = "ğŸ“´ æ”å½±æ©Ÿå·²é—œé–‰";
                    startButton.disabled = false;
                    stopButton.disabled = true;
                }
            }
    
            // æ“·å–ç•«é¢ä¸¦ç™¼é€è‡³ä¼ºæœå™¨
            function captureAndSendFrame() {
                if (!video.videoWidth || !video.videoHeight) return;
    
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
                const imageData = canvas.toDataURL("image/jpeg").split(",")[1];
    
                console.log("ğŸ“¤ ç™¼é€å½±åƒåˆ°ä¼ºæœå™¨...");
                socket.emit("stream_frame", { image: imageData });
    
                console.log("âœ… å½±åƒå·²é€å‡º");
            }
    
            startButton.addEventListener("click", startCamera);
            stopButton.addEventListener("click", stopCamera);
        </script>

    </body>
</html>

